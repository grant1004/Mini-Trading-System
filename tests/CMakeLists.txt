# tests/CMakeLists.txt - æ”¹é€²ç‰ˆæœ¬

# å•Ÿç”¨æ¸¬è©¦
enable_testing()

# æ”¶é›†æ¸¬è©¦æª”æ¡ˆ
file(GLOB_RECURSE TEST_SOURCES 
    "*test*.cpp"
    "*_test.cpp"
    "test_*.cpp"
)

# è¨­å®šæ¸¬è©¦é€šç”¨é…ç½®
function(setup_test_target test_name test_file)
    # å»ºç«‹æ¸¬è©¦å¯åŸ·è¡Œæª”
    add_executable(${test_name} ${test_file})
    
    # é€£çµå¿…è¦çš„å‡½å¼åº«
    target_link_libraries(${test_name} PRIVATE
        GTest::gtest 
        GTest::gtest_main
        GTest::gmock 
        GTest::gmock_main
    )
    
    # å¦‚æœæœ‰ä¸»è¦å‡½å¼åº«ï¼Œä¹Ÿè¦é€£çµ
    if(TARGET mts_lib)
        target_link_libraries(${test_name} PRIVATE mts_lib)
    else()
        target_link_libraries(${test_name} PRIVATE
            Boost::system 
            Boost::thread
            nlohmann_json::nlohmann_json
        )
    endif()
    
    # è¨­å®šæ¨™é ­æª”è·¯å¾‘
    target_include_directories(${test_name} PRIVATE 
        ${CMAKE_SOURCE_DIR}/src
    )
    
    target_compile_features(${test_name} PRIVATE cxx_std_17)
    
    # Windows ç‰¹å®šè¨­å®š
    if(WIN32)
        target_compile_definitions(${test_name} PRIVATE
            _WIN32_WINNT=0x0601
            NOMINMAX
        )
    endif()
    
    # ğŸ¯ è¨»å†Šæ¸¬è©¦ä¸¦è¨­å®šå±¬æ€§
    # Windows Visual Studio éœ€è¦ç‰¹æ®Šè™•ç†è·¯å¾‘
    if(WIN32 AND CMAKE_GENERATOR MATCHES "Visual Studio")
        # Visual Studio æœƒå°‡åŸ·è¡Œæª”æ”¾åœ¨ Debug/Release å­ç›®éŒ„
        add_test(NAME ${test_name} 
                 COMMAND $<TARGET_FILE:${test_name}>)
    else()
        add_test(NAME ${test_name} COMMAND ${test_name})
    endif()
    
    # è¨­å®šæ¸¬è©¦å±¬æ€§
    set_tests_properties(${test_name} PROPERTIES
        TIMEOUT 60                    # 60ç§’è¶…æ™‚
        WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    )
    
    # ğŸ¯ æ–°å¢ï¼šæ ¹æ“šæ¸¬è©¦é¡å‹è¨­å®šæ¨™ç±¤
    if(${test_name} MATCHES ".*performance.*" OR ${test_name} MATCHES ".*stress.*")
        set_tests_properties(${test_name} PROPERTIES LABELS "performance")
    elseif(${test_name} MATCHES ".*integration.*")
        set_tests_properties(${test_name} PROPERTIES LABELS "integration") 
    else()
        set_tests_properties(${test_name} PROPERTIES LABELS "unit")
    endif()
endfunction()

# å¦‚æœæœ‰æ¸¬è©¦æª”æ¡ˆï¼Œå»ºç«‹æ¸¬è©¦å¯åŸ·è¡Œæª”
if(TEST_SOURCES)
    foreach(test_file ${TEST_SOURCES})
        # å–å¾—æª”æ¡ˆåç¨±ï¼ˆç„¡æ“´å±•åï¼‰ä½œç‚ºæ¸¬è©¦åç¨±
        get_filename_component(test_name ${test_file} NAME_WE)
        
        # ä½¿ç”¨é€šç”¨é…ç½®å‡½å¼
        setup_test_target(${test_name} ${test_file})
        
        message(STATUS "Added test: ${test_name}")
    endforeach()
    
    # ğŸ¯ æ–°å¢ï¼šå»ºç«‹æ¸¬è©¦ç›®æ¨™ç¾¤çµ„
    add_custom_target(run_unit_tests
        COMMAND ${CMAKE_CTEST_COMMAND} -L unit --output-on-failure
        DEPENDS ${TEST_SOURCES}
        COMMENT "Running unit tests"
    )
    
    add_custom_target(run_all_tests
        COMMAND ${CMAKE_CTEST_COMMAND} --output-on-failure
        DEPENDS ${TEST_SOURCES} 
        COMMENT "Running all tests"
    )
    
else()
    message(STATUS "No test files found in tests directory")
endif()

# ğŸ¯ æ–°å¢ï¼šæ¸¬è©¦è¦†è“‹ç‡æ”¯æ´ï¼ˆå¯é¸ï¼‰
if(CMAKE_BUILD_TYPE STREQUAL "Debug" AND CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
    option(ENABLE_COVERAGE "Enable coverage reporting" OFF)
    
    if(ENABLE_COVERAGE)
        find_program(GCOV_PATH gcov)
        find_program(LCOV_PATH lcov)
        find_program(GENHTML_PATH genhtml)
        
        if(GCOV_PATH AND LCOV_PATH AND GENHTML_PATH)
            target_compile_options(mts_lib PRIVATE --coverage)
            target_link_libraries(mts_lib PRIVATE --coverage)
            
            add_custom_target(coverage
                COMMAND ${LCOV_PATH} --directory . --capture --output-file coverage.info
                COMMAND ${LCOV_PATH} --remove coverage.info '/usr/*' --output-file coverage.info.cleaned
                COMMAND ${GENHTML_PATH} -o coverage coverage.info.cleaned
                COMMAND ${CMAKE_COMMAND} -E remove coverage.info coverage.info.cleaned
                WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
                COMMENT "Generating coverage report"
            )
        endif()
    endif()
endif()