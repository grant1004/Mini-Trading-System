# Mini Trading System (MTS)

一個使用 C++17 和 FIX 4.4 協議實現的高性能交易系統，支援多客戶端連線、即時撮合引擎和完整的風險管理機制。

## 📋 目錄

- [系統概述](#系統概述)
- [系統架構](#系統架構)
- [系統流程](#系統流程)
- [快速開始](#快速開始)
- [使用指南](#使用指南)
- [API 文檔](#api-文檔)
- [測試](#測試)
- [系統監控](#系統監控)

## 🎯 系統概述

MTS 是一個企業級的迷你交易系統，具備以下核心功能：

### 核心特性
- **高性能撮合引擎**：支援價格時間優先原則的即時訂單撮合
- **FIX 4.4 協議**：完整實現金融資訊交換協議標準
- **多客戶端支援**：支援同時處理多個客戶端連線
- **風險管理**：內建訂單驗證和風險控制機制
- **即時市場資料**：提供即時的市場深度和成交資訊
- **高可用性**：優雅關閉、健康檢查和錯誤恢復機制

### 支援的訂單類型
- **市價單 (Market Order)**：立即以市場最佳價格成交
- **限價單 (Limit Order)**：指定價格的掛單交易
- **停損單 (Stop Order)**：觸發條件後轉為市價單
- **停損限價單 (Stop Limit Order)**：觸發後轉為限價單

### 時效性選項
- **當日有效 (DAY)**：當日結束後自動取消
- **取消前有效 (GTC)**：除非手動取消否則一直有效
- **立即成交否則取消 (IOC)**：立即成交，未成交部分取消
- **全部成交否則取消 (FOK)**：必須全部成交否則整筆取消

## 🏗️ 系統架構

```
┌─────────────────────────────────────────────────────────────┐
│                        客戶端層                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   交易員1    │  │   交易員2    │  │   算法交易   │         │
│  │  (Telnet)   │  │  (GUI App)  │  │   (API)     │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ FIX 4.4 Messages
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       網路層                                 │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                   TCP Server                           │ │
│  │  • 多執行緒客戶端處理                                     │ │
│  │  • 連線管理與心跳檢測                                     │ │
│  │  │  • 事件驅動回調機制                                    │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                 整合式交易系統架構                            │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                  Trading System                         │ │
│  │               (主控制器 + FIX Gateway)                   │ │
│  │                                                        │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │ │
│  │  │ TCP Server  │  │ FIX Session │  │   Order     │     │ │
│  │  │   Manager   │  │   Manager   │  │ Processing  │     │ │
│  │  │             │  │             │  │             │     │ │
│  │  │ • 客戶端連線 │  │ • FIX 協議   │  │ • 訊息轉換  │     │ │
│  │  │ • 多執行緒  │  │ • 動態CompID │  │ • 訂單映射  │     │ │
│  │  │ • 生命週期  │  │ • 序列號管理 │  │ • 狀態追蹤  │     │ │
│  │  │ • 事件回調  │  │ • 訊息驗證  │  │ • 執行回報  │     │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     撮合引擎                                 │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                 Matching Engine                         │ │
│  │                                                        │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │ │
│  │  │ Order Book  │  │    Risk     │  │  Execution  │     │ │
│  │  │   Manager   │  │ Management  │  │   Reports   │     │ │
│  │  │             │  │             │  │             │     │ │
│  │  │ • 買單佇列  │  │ • 價格檢查  │  │ • 成交確認  │     │ │
│  │  │ • 賣單佇列  │  │ • 數量檢查  │  │ • 狀態更新  │     │ │
│  │  │ • 撮合演算法 │  │ • 限額控制  │  │ • 回報生成  │     │ │
│  │  │ • 市場資料  │  │ • 符號驗證  │  │ • 事件通知  │     │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 核心組件說明

#### 1. **TradingSystem** (整合式交易系統核心)
- **職責**：系統的中央控制器，整合了 Gateway、Session Manager 和 Application Layer
- **整合功能**：
  - **TCP 連線管理**：多執行緒客戶端處理，連線生命週期管理
  - **FIX 協議處理**：動態 CompID 分配，訊息解析和驗證
  - **Session 管理**：每客戶端獨立 FixSession，狀態追蹤
  - **訂單處理**：FIX 訊息轉換為內部 Order 物件
  - **執行回報路由**：撮合結果轉為 FIX 回報並發送給對應客戶端
  - **統計資訊收集**：連線數、訂單數、成交數統計

#### 2. **MatchingEngine** (撮合引擎)
- **職責**：處理所有訂單的撮合和執行
- **功能**：
  - 高性能的價格-時間優先撮合演算法
  - 支援多種撮合模式（連續、集合競價、定期撮合）
  - 內建風險檢查和訂單驗證
  - 執行報告的生成和分發

#### 3. **OrderBook** (訂單簿)
- **職責**：維護特定交易標的的買賣訂單佇列
- **功能**：
  - 價格水準的分層管理
  - 同價位訂單的時間優先排序
  - 高效的訂單插入、修改和取消
  - 市場深度資料的計算

#### 4. **FIX Protocol Layer** (FIX 協議層)
- **職責**：處理 FIX 4.4 協議的所有細節
- **功能**：
  - 訊息的解析和序列化
  - 欄位驗證和檢查碼計算
  - 會話管理和序列號控制
  - 心跳和重連機制

#### 5. **TCP Server** (網路服務層)
- **職責**：處理所有網路通訊
- **功能**：
  - 多執行緒客戶端連線處理
  - 非阻塞 I/O 和事件驅動架構
  - 連線健康檢查和自動清理
  - 訊息的可靠傳輸

## 🔄 系統流程

### 1. 客戶端連線流程

```
客戶端                TCP Server              FIX Session            Trading System
   │                     │                      │                        │
   │──── TCP 連線請求 ──────►│                      │                        │
   │                     │                      │                        │
   │◄─── 連線確認 ─────────│                      │                        │
   │                     │                      │                        │
   │                     │─── 建立會話 ─────────►│                        │
   │                     │                      │                        │
   │                     │                      │─── 註冊客戶端 ────────►│
   │                     │                      │                        │
   │─── FIX 登入訊息 ────────►│─── 轉發 ─────────────►│─── 驗證處理 ──────────►│
   │                     │                      │                        │
   │◄── 登入確認 ──────────│◄── 回應 ────────────│◄─── 登入成功 ─────────│
```

### 2. 訂單處理流程

```
客戶端                      Trading System (整合式處理)                    Matching Engine        Order Book
   │                              │                                           │                    │
   │─── 新訂單 (D) ─────────────────►│ [TCP Server 接收]                      │                    │
   │                              │ [FixSession 解析驗證]                    │                    │
   │                              │ [convertFixToOrder()]                    │                    │
   │                              │                                           │                    │
   │                              │─── submitOrder() ─────────────────────►│                    │
   │                              │                                           │                    │
   │                              │                                           │─── 加入訂單簿 ─────►│
   │                              │                                           │                    │
   │                              │                                           │◄── 撮合結果 ──────│
   │                              │                                           │                    │
   │                              │◄── ExecutionReport (回調) ─────────────│                    │
   │                              │ [轉換為 FIX ExecutionReport]             │                    │
   │                              │ [FixSession 發送]                        │                    │
   │◄── 執行報告 (8) ──────────────│ [TCP Server 傳送]                      │                    │
```

### 3. 撮合演算法流程

```
新訂單進入
    │
    ▼
 ┌─────────┐
 │風險檢查 │
 └────┬────┘
      │
      ▼
 ┌─────────┐    拒絕    ┌─────────┐
 │訂單驗證 │ ────────► │發送拒絕 │
 └────┬────┘           └─────────┘
      │ 通過
      ▼
 ┌─────────┐
 │市價單？ │
 └────┬────┘
      │
   ┌──┴──┐
   │ 是  │ 否
   ▼     ▼
┌────────┐ ┌─────────┐
│立即撮合│ │加入訂單簿│
└───┬────┘ └────┬────┘
    │           │
    ▼           ▼
┌─────────────────┐
│   撮合處理      │
│                │
│ 1. 尋找對手單   │
│ 2. 價格匹配     │
│ 3. 數量配對     │
│ 4. 生成交易     │
└────────┬────────┘
         │
         ▼
    ┌─────────┐
    │更新訂單簿│
    └────┬────┘
         │
         ▼
    ┌─────────┐
    │發送回報 │
    └─────────┘
```

### 4. 訊息類型與處理

| FIX 訊息類型 | 說明 | 處理流程 |
|-------------|------|---------|
| **Logon (A)** | 登入請求 | 驗證憑證 → 建立會話 → 發送確認 |
| **NewOrderSingle (D)** | 新訂單 | 解析 → 驗證 → 提交撮合 → 回報 |
| **OrderCancelRequest (F)** | 取消訂單 | 查找訂單 → 移除訂單簿 → 確認取消 |
| **OrderStatusRequest (H)** | 訂單狀態查詢 | 查找訂單 → 返回當前狀態 |
| **ExecutionReport (8)** | 執行回報 | 訂單狀態更新 → 通知客戶端 |
| **Heartbeat (0)** | 心跳 | 維持連線活性 |
| **TestRequest (1)** | 測試請求 | 回應 Heartbeat |

## 🚀 快速開始

### 系統需求

- **作業系統**：Linux, Windows (WSL2), macOS
- **編譯器**：支援 C++17 的編譯器 (GCC 7+, Clang 6+, MSVC 2019+)
- **CMake**：3.20 或更高版本
- **依賴套件**：
  - Boost (system, thread)
  - Google Test (測試框架)
  - nlohmann/json (JSON 處理)

### 編譯和安裝

```bash
# 1. 克隆專案
git clone <repository-url>
cd Mini-Trading-System

# 2. 安裝依賴 (Ubuntu/Debian)
sudo apt update
sudo apt install build-essential cmake libboost-dev libgtest-dev nlohmann-json3-dev

# 3. 建立編譯目錄
mkdir build && cd build

# 4. 配置和編譯
cmake .. -DCMAKE_BUILD_TYPE=Debug
make -j$(nproc)

# 5. 執行測試
ctest -V

# 6. 安裝 (可選)
sudo make install
```

### 快速啟動

```bash
# 啟動交易系統 (預設埠號 8080)
./mts_app

# 指定埠號
./mts_app --port 9090

# 啟用測試模式
./mts_app --test

# 查看說明
./mts_app --help
```

## 📖 使用指南

### 連線到系統

使用任何支援 TCP 的客戶端連線到系統：

```bash
# 使用 telnet 連線
telnet localhost 8080

# 使用 netcat
nc localhost 8080
```

### FIX 訊息範例

#### 1. 登入訊息
```
8=FIX.4.4|9=65|35=A|49=CLIENT001|56=MTS|34=1|52=20241127-10:30:00|553=trader1|554=password123|10=XXX|
```

#### 2. 新訂單 - 買入限價單
```
8=FIX.4.4|9=XXX|35=D|49=CLIENT001|56=MTS|34=2|52=20241127-10:31:00|11=ORDER001|55=AAPL|54=1|38=100|40=2|44=150.50|59=0|10=XXX|
```

#### 3. 新訂單 - 賣出市價單
```
8=FIX.4.4|9=XXX|35=D|49=CLIENT001|56=MTS|34=3|52=20241127-10:32:00|11=ORDER002|55=AAPL|54=2|38=50|40=1|59=3|10=XXX|
```

#### 4. 取消訂單
```
8=FIX.4.4|9=XXX|35=F|49=CLIENT001|56=MTS|34=4|52=20241127-10:33:00|11=CANCEL001|41=ORDER001|55=AAPL|54=1|10=XXX|
```

### 訊息欄位說明

| 欄位 | 說明 | 範例值 |
|------|------|-------|
| **8** | FIX 版本 | FIX.4.4 |
| **9** | 訊息長度 | 計算值 |
| **35** | 訊息類型 | D=新訂單, F=取消, A=登入 |
| **49** | 發送方 | CLIENT001 |
| **56** | 接收方 | MTS |
| **34** | 序列號 | 遞增數字 |
| **52** | 發送時間 | YYYYMMDD-HH:MM:SS |
| **11** | 客戶訂單 ID | ORDER001 |
| **55** | 交易標的 | AAPL, TSLA, MSFT |
| **54** | 買賣方向 | 1=買, 2=賣 |
| **38** | 訂單數量 | 100 |
| **40** | 訂單類型 | 1=市價, 2=限價 |
| **44** | 價格 | 150.50 |
| **59** | 時效性 | 0=當日, 1=GTC, 3=IOC, 4=FOK |
| **10** | 檢查碼 | 計算值 |

## 🔧 API 文檔

### 系統控制命令

在系統運行時，可以在控制台輸入以下命令：

| 命令 | 說明 |
|------|------|
| `stats` | 顯示系統統計資訊 |
| `help` | 顯示可用命令 |
| `quit` / `exit` | 優雅關閉系統 |
| `Ctrl+C` | 信號式優雅關閉 |

### 統計資訊

```
📊 Trading System Statistics:
- Active Sessions: 3
- Total Connections: 15
- Total Orders: 1,247
- Total Trades: 823
- System Uptime: 2h 15m 30s

📈 Matching Engine Stats:
- Orders Processed: 1,247
- Trades Executed: 823
- Orders Rejected: 12
- Average Processing Time: 0.15ms
- Throughput: 2,450 orders/sec
```

### 設定檔案

系統支援透過 CMake 選項進行編譯時設定：

```bash
# 啟用所有 FIX 除錯選項
cmake .. -DENABLE_FIX_DEBUG=ON

# 停用風險檢查 (僅用於測試)
cmake .. -DENABLE_RISK_CHECK=OFF

# 設定最大客戶端數量
cmake .. -DMAX_CLIENTS=1000
```

## 🧪 測試

### 執行所有測試

```bash
# 在 build 目錄下
ctest -V

# 或者執行個別測試
./test_order_book
./test_fix_message
./test_matching_engine
```

### 測試涵蓋範圍

- **單元測試**：Order, OrderBook, FixMessage 類別
- **整合測試**：MatchingEngine 與 TradingSystem 整合
- **壓力測試**：高頻訂單處理和撮合性能
- **網路測試**：TCP 連線和 FIX 協議處理

### 效能測試

```bash
# 使用內建測試客戶端
./mts_app --test

# 外部壓力測試工具
python3 tools/stress_test.py --host localhost --port 8080 --orders 10000
```

## 📊 系統監控

### 即時監控

系統提供多層級的監控資訊：

1. **系統層級**：連線數、系統運行時間、記憶體使用
2. **交易層級**：訂單處理量、成交統計、拒絕率
3. **效能層級**：處理延遲、吞吐量、佇列深度
4. **錯誤層級**：連線錯誤、協議錯誤、系統異常

### 日誌設定

系統使用分級日誌：

- **INFO**：一般操作資訊
- **WARN**：警告事件 (如訂單拒絕)
- **ERROR**：錯誤事件 (如連線失敗)
- **DEBUG**：詳細除錯資訊 (FIX 訊息內容)

### 健康檢查

系統內建健康檢查機制：

- **連線健康**：定期檢查客戶端連線狀態
- **會話健康**：監控 FIX 會話活性
- **引擎健康**：撮合引擎效能指標
- **記憶體健康**：監控記憶體使用和洩漏

## 🛠️ 進階設定

### 撮合引擎設定

```cpp
// 設定撮合模式
matchingEngine->setMatchingMode(MatchingEngine::MatchingMode::Continuous);

// 風險管理參數
matchingEngine->setMaxOrderPrice(1000.0);
matchingEngine->setMaxOrderQuantity(1000000);
matchingEngine->setMaxOrdersPerSymbol(10000);

// 效能參數
matchingEngine->setMaxProcessingTime(std::chrono::microseconds(1000));
```

### 網路設定

```cpp
// TCP 服務器設定
tcpServer->setMaxConnections(1000);
tcpServer->setKeepAlive(true);
tcpServer->setReadTimeout(30); // 秒
```

## 🤝 貢獻指南

歡迎對 MTS 項目貢獻代碼！請遵循以下準則：

1. **代碼風格**：遵循 Google C++ Style Guide
2. **測試要求**：新功能必須包含對應的單元測試
3. **文檔更新**：更新相關的 API 文檔和使用說明
4. **效能考慮**：關注代碼的效能影響，特別是關鍵路徑

## 📄 授權條款

本項目採用 MIT 授權條款，詳見 [LICENSE](LICENSE) 檔案。

## 📞 支援與聯絡

如有問題或建議，請通過以下方式聯絡：

- **Issue 回報**：[GitHub Issues](https://github.com/your-repo/issues)
- **功能請求**：[GitHub Discussions](https://github.com/your-repo/discussions)
- **技術支援**：[Email](mailto:support@your-domain.com)

---

**MTS - 專業級交易系統解決方案** 🚀